<!DOCTYPE html><html lang="zh-Hans">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>UIWebView和WKWebView的一些比较 - Argost's Home</title>

<meta name="description" content="介绍一下UIWebView和WKWebView楔子在我们使用UIWebView的过程中应该有发现UIWebView可是个吃内存的大户，动辄就是上百兆的内存，虽说现在iPhone的性能越来越好，但是也经不住如此折腾啊，况且，一个APP如果占用的系统内存超过整机内存总数的一半时是会被优先kill掉的。WKWebVie...">
<link rel="canonical" href="http://localhost:4000/ios/2018/01/11/UIWebView%E5%92%8CWKWebView.html"><link rel="alternate" type="application/rss+xml" title="Argost's Home" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://use.fontawesome.com/releases/v5.0.13/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>
<a title="My personal Blog Site
" href="/">Argost's Home</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/archive.html">归档</a></li><li class="navigation__item"><a href="/about.html">关于</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>UIWebView和WKWebView的一些比较</h1></header><span class="split-space">&nbsp;</span>
          <a class="edit-on-github"
            title="在 Github 上修改"
            href="https://github.com/cambriayang/cambriayang.github.io/tree/master/_posts/2018-01-11-UIWebView和WKWebView.md">
            <i class="far fa-edit"></i></a></div><meta itemprop="headline" content="UIWebView和WKWebView的一些比较"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E5%AD%A6%E4%B9%A0">学习</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>2018年 01月11日</span>
            </li></ul></div><meta itemprop="author" content="Cambria Yang"/><meta itemprop="datePublished" content="2018-01-11T10:00:00+00:00">
    <meta itemprop="keywords" content="学习"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><p>介绍一下UIWebView和WKWebView</p>

<h2 id="楔子">楔子</h2>
<p>在我们使用UIWebView的过程中应该有发现UIWebView可是个吃内存的大户，动辄就是上百兆的内存，虽说现在iPhone的性能越来越好，但是也经不住如此折腾啊，况且，一个APP如果占用的系统内存超过整机内存总数的一半时是会被优先kill掉的。
WKWebView 是苹果在 WWDC 2014 上推出的新一代 webView 组件，用以替代 UIKit 中笨重难用、内存泄漏的 UIWebView。WKWebView 拥有60fps滚动刷新率、和 safari 相同的 JavaScript 引擎等优势。</p>

<p>下面就简单讲讲</p>

<h2 id="uiwebview的内存问题以及一些改进方式">UIWebView的内存问题以及一些改进方式</h2>
<p>部分App（好吧，可能说很多）喜欢将UIWebView的frame根据内容自适配，因为他们需要在下面添加一些自定义的view，如tableview（需要滚动）等。这种方式正常情况下是没有什么问题的，但是需要考虑一下一些变态情况，如：</p>
<blockquote>
  <p>http://m.thepaper.cn/wifiKey_detail.jsp?contid=1913999&amp;from=wifiKey&amp;fromId=1966555810873344&amp;newsId=26~2490337347993600&amp;docId=26~249033743474688</p>
</blockquote>

<p>这个link如果全展开的话，高度超过30000px，最要命的是，如果将webview也进行展开的话，内存直接会飙升到500MB左右，如果说只是将其frame固定，内容滚动的话，比如下图的样式：
<img src="http://localhost:4000/assets/images/posts/webview_1.jpg" alt="" /></p>

<p>此时的内存大小如下图所示:
<img src="http://localhost:4000/assets/images/posts/webview_2.jpg" alt="" />
其实刚进去的时候，内存很小，大概几十兆，此时webview是白屏，等load完就是图一的大小了，可见UIWebView确实是内存大户。</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">int</span> <span class="n">cacheSizeMemory</span> <span class="o">=</span> <span class="mf">4*1024*</span><span class="mi">1024</span><span class="p">;</span> <span class="c1">// 4MB</span>
    <span class="n">int</span> <span class="n">cacheSizeDisk</span> <span class="o">=</span> <span class="mf">32*1024*</span><span class="mi">1024</span><span class="p">;</span> <span class="c1">// 32MB</span>

    <span class="kt">NSURLCache</span> <span class="o">*</span><span class="n">sharedCache</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">NSURLCache</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithMemoryCapacity</span><span class="p">:</span><span class="n">cacheSizeMemory</span> <span class="nv">diskCapacity</span><span class="p">:</span><span class="n">cacheSizeDisk</span> <span class="nv">diskPath</span><span class="p">:</span><span class="kc">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="kt">NSURLCache</span> <span class="nv">setSharedURLCache</span><span class="p">:</span><span class="n">sharedCache</span><span class="p">];</span>
</code></pre></div></div>
<p>这段代码相信大家在很多 ` AppDelegate ` 里应该都看过，能起到一定作用，但是效果不是非常大。
这里需要注意一下 <code class="language-plaintext highlighter-rouge">diskPath:nil</code> 经过和我同事的讨论，是使用默认的path去建立disk缓存，如果你使用自己的path，系统会递归去命中缓存，不过这块我还需要自己去实践一下，待考。</p>

<p><strong>下面提供另一种思路：</strong>
其实大家想将webview展开到全尺寸，无非就是想让下面的view能够实现自己的业务逻辑，以uitableview为例。实际上，我们可以将tableview进行全展开，虽然也会有些内存浪费，当时绝对比webview全展开来的少，毕竟tableview更加成熟。</p>

<p>其实webview之所以能够滚动，也是因为内部有UIScrollView。</p>

<p><img src="http://localhost:4000/assets/images/posts/webview_3.jpg" alt="" /></p>

<p>那么很自然的，我们可以取到这个srollview，将自己的view添加到这上面不就可以了么。</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">self</span><span class="o">.</span><span class="n">webView</span> <span class="o">=</span> <span class="n">web</span><span class="p">;</span>
  
    <span class="kt">NSString</span> <span class="o">*</span><span class="n">urlStr</span> <span class="o">=</span> <span class="s">@"http://m.thepaper.cn/wifiKey_detail.jsp?contid=1913999&amp;from=wifiKey&amp;fromId=1966555810873344&amp;newsId=26~2490337347993600&amp;docId=26~249033743474688"</span><span class="p">;</span>
    
    <span class="kt">NSString</span> <span class="o">*</span><span class="n">encodedString</span> <span class="o">=</span> <span class="p">[</span><span class="n">urlStr</span> <span class="nv">stringByAddingPercentEncodingWithAllowedCharacters</span><span class="p">:[</span><span class="kt">NSCharacterSet</span> <span class="kt">URLQueryAllowedCharacterSet</span><span class="p">]];</span>
    
    <span class="kt">NSURL</span> <span class="o">*</span><span class="n">weburl</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSURL</span> <span class="kt">URLWithString</span><span class="p">:</span><span class="n">encodedString</span><span class="p">];</span>
    
    <span class="kt">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">NSURLRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithURL</span><span class="p">:</span><span class="n">weburl</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">web</span> <span class="nv">loadRequest</span><span class="p">:</span><span class="n">request</span><span class="p">];</span>
    
    <span class="n">web</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
    
    <span class="kt">UIScrollView</span> <span class="o">*</span><span class="n">myScrollView</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">webView</span><span class="o">.</span><span class="n">scrollView</span><span class="p">;</span>
    
    <span class="kt">UIView</span> <span class="o">*</span><span class="n">containerView</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UIView</span> <span class="k">new</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">myScrollView</span> <span class="nv">addSubview</span><span class="p">:</span><span class="n">containerView</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">containerView</span> <span class="nv">mas_makeConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="nf">equalTo</span><span class="p">(</span><span class="n">myScrollView</span><span class="p">);</span>
        <span class="n">make</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="nf">mas_equalTo</span><span class="p">([</span><span class="kt">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">);</span>
        <span class="n">make</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="nf">mas_equalTo</span><span class="p">(</span><span class="n">defaultTableH</span><span class="p">);</span>
    <span class="p">}];</span>
    
    <span class="k">self</span><span class="o">.</span><span class="n">containerView</span> <span class="o">=</span> <span class="n">containerView</span><span class="p">;</span>
    
    <span class="kt">UITableView</span> <span class="o">*</span><span class="n">tableview</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UITableView</span> <span class="k">new</span><span class="p">];</span>
    
    <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">containerView</span> <span class="nv">addSubview</span><span class="p">:</span><span class="n">tableview</span><span class="p">];</span>
    
    <span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="o">=</span> <span class="n">tableview</span><span class="p">;</span>
    <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">scrollEnabled</span> <span class="o">=</span> <span class="kt">NO</span><span class="p">;</span>
    
    <span class="n">tableview</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
    <span class="n">tableview</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
    <span class="n">tableview</span><span class="o">.</span><span class="n">showsVerticalScrollIndicator</span> <span class="o">=</span> <span class="kt">NO</span><span class="p">;</span>
</code></pre></div></div>
<p>由于scrollview的autolayout比较特殊，所以这里采用了拉出一个containerView的原因，具体参见：</p>

<blockquote>
  <p>http://mokagio.github.io/tech-journal/2015/06/24/ios-scroll-view-and-interface-builder.html</p>
</blockquote>

<p>这里tableview只是添加上去，真正布局在下面的方法里：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">webViewDidFinishLoad</span><span class="p">:(</span><span class="kt">UIWebView</span> <span class="o">*</span><span class="p">)</span><span class="n">webView</span> <span class="p">{</span>
    <span class="c1">//获取页面高度（像素）</span>
    <span class="kt">NSString</span> <span class="o">*</span> <span class="n">clientheight_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">webView</span> <span class="nv">stringByEvaluatingJavaScriptFromString</span><span class="p">:</span> <span class="s">@"document.body.offsetHeight"</span><span class="p">];</span>
    <span class="n">float</span> <span class="n">contentH</span> <span class="o">=</span> <span class="p">[</span><span class="n">clientheight_str</span> <span class="n">floatValue</span><span class="p">];</span>

    <span class="p">[</span><span class="k">self</span> <span class="nv">resizeWebContentHeight</span><span class="p">:</span><span class="n">contentH</span><span class="p">];</span>
    
    <span class="kd">@weakify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="nf">dispatch_after</span><span class="p">(</span><span class="nf">dispatch_time</span><span class="p">(</span><span class="kt">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="p">(</span><span class="n">int64_t</span><span class="p">)(</span><span class="mi">5</span> <span class="o">*</span> <span class="kt">NSEC_PER_SEC</span><span class="p">)),</span> <span class="nf">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
        <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
        <span class="n">defaultRowCount</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">defaultRowHeight</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
        <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
        
        <span class="p">[</span><span class="k">self</span> <span class="nv">resizeWebContentHeight</span><span class="p">:</span><span class="n">contentH</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里的 <code class="language-plaintext highlighter-rouge">dispatch_after</code> 实际上模拟数据源变好，tableview的刷新过程。
<code class="language-plaintext highlighter-rouge">resizeWebContentHeight</code> 如下：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">resizeWebContentHeight</span><span class="p">:(</span><span class="kt">CGFloat</span><span class="p">)</span><span class="n">contentHeight</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">containerView</span> <span class="nv">mas_updateConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="nf">mas_equalTo</span><span class="p">(</span><span class="n">contentHeight</span><span class="o">+</span><span class="n">defaultTableH</span><span class="p">);</span>
    <span class="p">}];</span>
    
    <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="nv">mas_updateConstraints</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">MASConstraintMaker</span> <span class="o">*</span><span class="n">make</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">make</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="nf">mas_equalTo</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">containerView</span><span class="o">.</span><span class="n">mas_width</span><span class="p">);</span>
        <span class="n">make</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="nf">mas_equalTo</span><span class="p">(</span><span class="n">defaultTableH</span><span class="p">);</span>
        <span class="n">make</span><span class="o">.</span><span class="n">bottom</span><span class="o">.</span><span class="nf">mas_equalTo</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">containerView</span><span class="o">.</span><span class="n">mas_bottom</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这样就模拟的整个的滚动事件，贴两张实际效果图，一张是没更新数据源的图片，一张是更新后的样式：</p>

<p><img src="http://localhost:4000/assets/images/posts/webview_4.jpg" alt="" /></p>

<p>以及</p>

<p><img src="http://localhost:4000/assets/images/posts/webview_5.jpg" alt="" /></p>

<p>毫无违和感，滚动条也完美</p>

<h2 id="wkwebview">WKWebView</h2>
<p>简单的适配方法本文不再赘述，主要来说说适配 WKWebView 过程中填过的坑以及善待解决的技术难题。</p>

<h3 id="wkwebview的白屏问题">WKWebView的白屏问题</h3>
<p>WKWebView 自诩拥有更快的加载速度，更低的内存占用，但实际上 WKWebView 是一个多进程组件，Network Loading 以及 UI Rendering 在其它进程中执行。初次适配 WKWebView 的时候，我们也惊讶于打开 WKWebView 后，App 进程内存消耗反而大幅下降，但是仔细观察会发现，Other Process 的内存占用会增加。在一些用 webGL 渲染的复杂页面，使用 WKWebView 总体的内存占用（App Process Memory + Other Process Memory）不见得比 UIWebView 少很多。</p>

<p>在 UIWebView 上当内存占用太大的时候，App Process 会 crash；而在 WKWebView 上当总体的内存占用比较大的时候，WebContent Process 会 crash，从而出现白屏现象。</p>

<h3 id="wkwebview的cookie问题">WKWebView的Cookie问题</h3>
<p>Cookie 问题是目前 WKWebView 的一大短板，因为UIWebView的cookie和NSHTTPCookieStorage是共通的。所以说NSHTTPCookieStorage 的单例对象会自动将 cookie 添加到相应的 UIWebView 的 request 上。每次加载完页面以后 UIWebView 上生成的 cookie 也会自动保存到 NSHTTPCookieStorage 单例对象。</p>

<p>WKWebView 的 cookie 处理起来就很麻烦了。为了将 NSHTTPCookieStorage 单例对象的 cookie 设置到 WKWebView，需要在 loadRequest 的时候将 cookie 设置到 request 的 http 头上。代码如下：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">loadRequest</span><span class="p">:(</span><span class="kt">NSURLRequest</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span> <span class="p">{</span>
    <span class="kt">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">mutableCopy</span><span class="p">;</span>
    <span class="kt">NSString</span> <span class="o">*</span><span class="n">urlString</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="kt">URL</span><span class="o">.</span><span class="n">absoluteString</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">urlString</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">urlString</span> <span class="nv">rangeOfString</span><span class="p">:</span><span class="s">@"www.xxx.com"</span><span class="p">]</span><span class="o">.</span><span class="n">location</span> <span class="o">!=</span> <span class="kt">NSNotFound</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NSHTTPCookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="c1">// specific cookie to be set;</span>
        <span class="kt">NSArray</span><span class="o">*</span> <span class="n">cookies</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSArray</span> <span class="nv">arrayWithObjects</span><span class="p">:</span> <span class="n">cookie</span><span class="p">,</span> <span class="kc">nil</span><span class="p">];</span>
        <span class="kt">NSDictionary</span> <span class="o">*</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSHTTPCookie</span> <span class="nv">requestHeaderFieldsWithCookies</span><span class="p">:</span><span class="n">cookies</span><span class="p">];</span>
        <span class="p">[</span><span class="n">request</span> <span class="nv">setAllHTTPHeaderFields</span><span class="p">:</span><span class="n">headers</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="p">[(</span><span class="kt">WKWebView</span> <span class="o">*</span><span class="p">)</span><span class="k">self</span><span class="o">.</span><span class="n">wkWebView</span> <span class="nv">loadRequest</span><span class="p">:</span><span class="n">request</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>如果有 AJAX 的 request 的话需要设置脚本（原理就是将本地 cookie 通过 js 设置到页面的 document.cookie）：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">WKUserContentController</span><span class="o">*</span> <span class="n">userContentController</span> <span class="o">=</span> <span class="kt">WKUserContentController</span><span class="o">.</span><span class="k">new</span><span class="p">;</span>
<span class="kt">WKUserScript</span> <span class="o">*</span> <span class="n">cookieScript</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">WKUserScript</span> <span class="n">alloc</span><span class="p">]</span> 
    <span class="nv">initWithSource</span><span class="p">:</span> <span class="s">@"document.cookie = 'TeskCookieKey1=TeskCookieValue1';document.cookie = 'TeskCookieKey2=TeskCookieValue2';"</span>
    <span class="nv">injectionTime</span><span class="p">:</span><span class="kt">WKUserScriptInjectionTimeAtDocumentStart</span> <span class="nv">forMainFrameOnly</span><span class="p">:</span><span class="kt">NO</span><span class="p">];</span>
<span class="c1">// again, use stringWithFormat: in the above line to inject your values programmatically</span>
<span class="p">[</span><span class="n">userContentController</span> <span class="nv">addUserScript</span><span class="p">:</span><span class="n">cookieScript</span><span class="p">];</span>
<span class="kt">WKWebViewConfiguration</span><span class="o">*</span> <span class="n">webViewConfig</span> <span class="o">=</span> <span class="kt">WKWebViewConfiguration</span><span class="o">.</span><span class="k">new</span><span class="p">;</span>
<span class="n">webViewConfig</span><span class="o">.</span><span class="n">userContentController</span> <span class="o">=</span> <span class="n">userContentController</span><span class="p">;</span>
<span class="kt">WKWebView</span> <span class="o">*</span> <span class="n">webView</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">WKWebView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithFrame</span><span class="p">:</span><span class="kt">CGRectMake</span><span class="p">(</span><span class="cm">/*set your values*/</span><span class="p">)</span> <span class="nv">configuration</span><span class="p">:</span><span class="n">webViewConfig</span><span class="p">];</span>

</code></pre></div></div>

<p>由于采用了新的实现机制，WKWebView 获取的 cookie 不会被设置到 NSHTTPCookieStorage 单例对象上。如果想要获取 WKWebView 上面的 cookie，同样可以是用 document.cookie。但是这种方式无法获取到 httpOnly 的 cookie。为了获取到所有的 WKWebView 上的 cookie。可以使用 NSURLProtocol，在 NSURLProtocol 得到调用的时候去取所有的相关 cookie。但是 WKWebView 默认并不走 NSURLProtocol，需要使用自定义protocol（私有API)：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="kt">NSClassFromString</span><span class="p">(</span><span class="s">@"WKBrowsingContextController"</span><span class="p">);</span>
    <span class="kt">SEL</span> <span class="n">sel</span> <span class="o">=</span> <span class="kt">NSSelectorFromString</span><span class="p">(</span><span class="s">@"registerSchemeForCustomProtocol:"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">([(</span><span class="n">id</span><span class="p">)</span><span class="n">cls</span> <span class="nv">respondsToSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// 把 http 和 https 请求交给 NSURLProtocol 处理</span>
<span class="cp">#pragma clang diagnostic push</span>
<span class="cp">#pragma clang diagnostic ignored "-Warc-performSelector-leaks"</span>
        <span class="p">[(</span><span class="n">id</span><span class="p">)</span><span class="n">cls</span> <span class="nv">performSelector</span><span class="p">:</span><span class="n">sel</span> <span class="nv">withObject</span><span class="p">:</span><span class="s">@"http"</span><span class="p">];</span>
        <span class="p">[(</span><span class="n">id</span><span class="p">)</span><span class="n">cls</span> <span class="nv">performSelector</span><span class="p">:</span><span class="n">sel</span> <span class="nv">withObject</span><span class="p">:</span><span class="s">@"https"</span><span class="p">];</span>
<span class="cp">#pragma clang diagnostic pop</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="kt">NSURLProtocol</span> <span class="nv">registerClass</span><span class="p">:[</span><span class="kt">CustomURLProtocol</span> <span class="kd">class</span><span class="p">]];</span>
</code></pre></div></div>
<p>所以，各位看官可以看出，目前最大的问题就是<strong>WKWebView 发起的请求不会自动带上存储于 NSHTTPCookieStorage 容器中的 Cookie。</strong> 这就很尴尬了啊。比如我有一个这样的cookie：</p>
<blockquote>
  <p>name=yy;value=yy;domain=yy.qq.com;expires=Sat, 02 May 2019 23:38:25 GMT；</p>
</blockquote>

<p>通过 UIWebView 发起请求，则会自动带上，但是WKWebView则不会。。。</p>

<p>不过这有牵扯到另一个问题了：</p>

<h3 id="wkwebview-nsurlprotocol问题">WKWebView NSURLProtocol问题</h3>

<p>这个方法不仅危险，而且也被腾讯的同学证明了有2个致命的缺陷：post 请求 body 数据被清空和对ATS支持不足（这一点我觉得目前应该不紧迫）</p>

<ul>
  <li>post 请求 body 数据被清空
由于 WKWebView 在独立进程里执行网络请求。一旦注册 http(s) scheme 后，网络请求将从 Network Process 发送到 App Process，这样 NSURLProtocol 才能拦截网络请求。在 webkit2 的设计里使用 MessageQueue 进行进程之间的通信，Network Process 会将请求 encode 成一个 Message,然后通过 IPC 发送给 App Process。出于性能的原因，encode 的时候 HTTPBody 和 HTTPBodyStream 这两个字段被丢弃掉了(参考苹果源码： 
https://github.com/WebKit/webkit/blob/fe39539b83d28751e86077b173abd5b7872ce3f9/Source/WebKit2/Shared/mac/WebCoreArgumentCodersMac.mm#L61-L88 及bug report: https://bugs.webkit.org/show_bug.cgi?id=138169)。
<strong>因此，如果通过 registerSchemeForCustomProtocol 注册了 http(s) scheme, 那么由 WKWebView 发起的所有 http(s)请求都会通过 IPC 传给主进程 NSURLProtocol 处理，导致 post 请求 body 被清空；</strong></li>
</ul>

<p><strong>这个问题在<code class="language-plaintext highlighter-rouge">loadRequest</code>的过程中，一样会有问题</strong>
一种解决思路是：
中间做个映射，简单来说就是自己生成自定义的schema，将post的body先copy到header中（不会丢失），然后注册custom schema，用<code class="language-plaintext highlighter-rouge">NSUrlProtocol</code>拦截请求，进行重组装.</p>

<h2 id="wkwebview的使用">WKWebView的使用</h2>
<p>WKWebVIew是UIWebView的代替品，新的WebKit框架把原来的功能拆分成许多小类。本例中主要用到了WKNavigationDelegate,WKUIDelegate,WKScriptMessageHandler三个委托和配置类WKWebViewConfiguration去实现webView的request控制，界面控制，js交互，alert重写等功能。 使用WKWebView需要引入 <code class="language-plaintext highlighter-rouge">#import &lt;WebKit/WebKit.h&gt;</code></p>

<h3 id="js中alert的拦截">js中alert的拦截</h3>
<p>在WKWebview中，js的alert是不会出现任何内容的，你必须重写WKUIDelegate委托的<code class="language-plaintext highlighter-rouge">runJavaScriptAlertPanelWithMessage message</code>方法，自己处理alert。类似的还有Confirm和prompt也和alert类似。</p>

<h3 id="app调js方法">app调js方法</h3>
<p>没什么区别</p>

<h3 id="config">Config</h3>
<p>WKWebView的config需要在初始化之前设置好</p>

<h3 id="wkwebview的相关的代理方法">WKWebView的相关的代理方法</h3>
<p>WKWebView的相关的代理方法分别在WKNavigationDelegate和WKUIDelegate以及WKScriptMessageHandler这个与JavaScript交互相关的代理方法。</p>

<ul>
  <li>WKNavigationDelegate: 此代理方法中除了原有的UIWebView的四个代理方法，还增加了其他的一些方法。</li>
  <li>WKUIDelegate: 此代理方法在使用中最好实现，否则遇到网页alert的时候，如果此代理方法没有实现，则不会出现弹框提示。</li>
  <li>WKScriptMessageHandler: 此代理方法就是和JavaScript交互相关，具体介绍参考下面的专门讲解。</li>
</ul>

<h3 id="wkwebview下面添加自定义view">WKWebView下面添加自定义View</h3>
<blockquote>
  <p>因为我们有个需求是在网页下面在添加一个View，用来展示此链接内容的相关评论。在使用UIWebView的时候，做法非常简单粗暴，在UIWebView的ScrollView后面添加一个自定义View，然后根据View的高度，在改变一下scrollView的contentSize属性。以为WKWebView也可以这样简单粗暴的去搞一下，结果却并不是这样。
首先改变WKWebView的scrollView的contentSize属性，系统会在下一次帧率刷新的时候，再给你改变回原有的，这样这条路就行不通了。我马上想到了另一个办法，改变scrollView的contentInset这个系统倒不会在变化回原来的，自以为完事大吉。后来过了两天，发现有些页面的部分区域的点击事件无法响应，百思不得其解，最后想到可能是设置的contentInset对其有了影响，事实上正是如此。查来查去，最后找到了一个解决办法是，就是当页面加载完成时，在网页下面拼一个空白的div，高度就是你添加的View的高度，让网页多出一个空白区域，自定义的View就添加在这个空白的区域上面。这样就完美解决了此问题。具体可参考Demo所写，核心代码如下:</p>
</blockquote>

<p>感谢<a href="https://www.jianshu.com/p/9513d101e582">Time_for</a>同学的实践，本人打算去写一个demo验证下，稍后更新。</p>

<h2 id="参考">参考</h2>
<ul>
  <li>http://blog.csdn.net/Tencent_Bugly/article/details/54668721</li>
  <li>https://danleechina.github.io/things-to-know-about-WKWebView-UIWebView/</li>
  <li>http://liuyanwei.jumppo.com/2015/10/17/ios-webView.html</li>
</ul>

</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2018-01-11T10:00:00+00:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe"><i class="fas fa-rss"></i> <a type="application/rss+xml" href="/feed.xml">订阅</a></div>
</div><div class="article__license"><div class="license">
    <p>本文遵守 <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by/4.0/">Attribution 4.0 International</a> 许可协议。
      <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Attribution 4.0 International" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>上篇</span><a href="/ios/2017/03/29/Weex%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">Weex学习笔记</a></div><div class="next"><span>下篇</span><a href="/ios/2018/02/15/%E6%A8%A1%E5%9D%97%E5%8C%96%E5%AE%9E%E8%B7%B5%E4%BB%A5%E5%8F%8A%E7%A7%81%E6%9C%89%E5%BA%93%E7%9B%B8%E5%85%B3%E4%BB%8B%E7%BB%8D.html">模块化实践以及私有库相关介绍</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cambria Yang"><meta itemprop="url" content="https://github.com/cambriayang"><meta itemprop="description" content="I am an Amazing person."><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><link itemprop="url" href="https://github.com/cambriayang"><li title="给我发邮件。">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:cambriayang@qq.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Argost's Home 2020,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">搜索</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        取消</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js'], function() {
    var $canvas = null, $this = null, _ctx = null, _text = '';
    $('.language-chart').each(function(){
      $this = $(this);
      $canvas = $('<canvas></canvas>');
      _text = $this.text();
      $this.text('').append($canvas);
      _ctx = $canvas.get(0).getContext('2d');
      (_ctx && _text) && (new Chart(_ctx, JSON.parse(_text)) && $this.attr('data-processed', true));
    });
  });
</script>
<script type="text/x-mathjax-config">
	var _config = { tex2jax: {
		inlineMath: [['$','$'], ['\\(','\\)']]
	}};_config.TeX = { equationNumbers: { autoNumber: "all" } };MathJax.Hub.Config(_config);
</script>
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

